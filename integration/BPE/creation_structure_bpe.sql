-- Requête SQL necessaire à la création de la structure utilisée pour insérer les donnnées de la base BPE

-- 1. Création de la table G_GEO.TA_BPE_GEOM
-- Creation de la table G_GEO.TA_BPE_GEOM qui recense les géométries que peuvent prendre les equipements de la Base Permanente des Equipements.

-- 1.1 Création de la table
CREATE TABLE G_GEO.TA_BPE_GEOM(
	objectid NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    geom SDO_GEOMETRY
	);


-- 1.2 Création des commentaires
COMMENT ON TABLE G_GEO.TA_BPE_GEOM IS 'Table regroupant les positions que peuvent prendre les équipements de la Base Permanente des Equipements';
COMMENT ON COLUMN G_GEO.TA_BPE_GEOM.objectid IS 'Clé primaire de la table G_GEO.TA_BPE_GEOM.';
COMMENT ON COLUMN G_GEO.TA_BPE_GEOM.geom IS 'Position géographique que peuvent prendre les équipements.';


-- 1.3 Création de la clé primaire
ALTER TABLE G_GEO.TA_BPE_GEOM
ADD CONSTRAINT ta_bpe_geom_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 1.4 Création des métadonnées spatiales
INSERT INTO USER_SDO_GEOM_METADATA(
    TABLE_NAME, 
    COLUMN_NAME, 
    DIMINFO, 
    SRID
)
VALUES(
    'G_GEO.TA_BPE_GEOM',
    'geom',
    SDO_DIM_ARRAY(SDO_DIM_ELEMENT('X', 594000, 964000, 0.005),SDO_DIM_ELEMENT('Y', 6987000, 7165000, 0.005)), 
    2154
);


-- 1.5 Création de l'index spatial sur le champ geom
CREATE INDEX ta_bpe_geom_SIDX
ON G_GEO.TA_BPE_GEOM(geom)
INDEXTYPE IS MDSYS.SPATIAL_INDEX
PARAMETERS('sdo_indx_dims=2, layer_gtype=POINT, tablespace=G_ADT_INDX, work_tablespace=DATA_TEMP');


-- 2. Creation de la table G_GEO.TA_BPE
-- Création de la table G_GEO.TA_BPE qui recense les équipements de la base permanente des equipements.

-- 2.1 Création de la table
CREATE TABLE G_GEO.TA_BPE(
    objectid NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY START WITH 1 INCREMENT BY 1,
    fid_metadonnee NUMBER(38,0)
    );


-- 2.2 Création des commentaires
COMMENT ON TABLE G_GEO.TA_BPE IS 'Table regroupant les equipements de la Base Permanente des Equipements.';
COMMENT ON COLUMN G_GEO.TA_BPE.objectid IS 'Clé primaire de la table G_GEO.TA_BPE.';
COMMENT ON COLUMN G_GEO.TA_BPE.fid_metadonnee IS 'Clé étrangère vers la table G_GEO.TA_METADONNEE pour connaitre la source de la données.';


-- 2.3 Création de la clé primaire
ALTER TABLE G_GEO.TA_BPE
ADD CONSTRAINT ta_bpe_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 2.4 Création des clés étrangères

-- 2.4.1 Création de la clé étrangère vers la table ta_metadonnée
ALTER TABLE G_GEO.TA_BPE
ADD CONSTRAINT  "TA_METADONNE_OBJECTID_FK"
FOREIGN KEY ("FID_METADONNEE")
REFERENCES  "TA_METADONNEE" ("OBJECTID");


-- 2.5 Création des index sur les cléfs étrangères.
CREATE INDEX ta_bpe_fid_metadonnee_IDX ON G_GEO.TA_BPE(fid_metadonnee)
TABLESPACE G_ADT_INDX;


-- 3. Création de la table G_GEO.TA_BPE_RELATION_GEOM
-- Creation de la table G_GEO.TA_BPE_RELATION_GEOM, table de correspondance entre les BPE et leurs positions géographiques.

-- 3.1 Creation de la table
CREATE TABLE G_GEO.TA_BPE_RELATION_GEOM(
	fid_bpe NUMBER(38,0),
	fid_bpe_geom NUMBER(38,0)
	);

-- 3.2 Création des commentaires des colonnes
COMMENT ON TABLE G_GEO.TA_BPE_RELATION_GEOM IS 'Table de liaison entre les équipements et leurs géométries';
COMMENT ON COLUMN G_GEO.TA_BPE_RELATION_GEOM.fid_bpe IS 'Clé étrangère vers la table G_GEO.TA_BPE. Composante de la clé primaire.';
COMMENT ON COLUMN G_GEO.TA_BPE_RELATION_GEOM.fid_bpe_geom IS 'Clé étrangère vers la table G_GEO.TA_BPE_GEOM. Composante de la clé primaire.';

-- 3.3 Ajout de la clé primaire
ALTER TABLE G_GEO.TA_BPE_RELATION_GEOM
ADD CONSTRAINT ta_bpe_relation_geom_PK 
PRIMARY KEY(fid_bpe,fid_bpe_geom)
USING INDEX TABLESPACE "G_ADT_INDX";

-- 3.4 Création des clés étrangères

-- 3.4.1 vers la table G_GEO.TA_BPE
ALTER TABLE G_GEO.TA_BPE_RELATION_GEOM
ADD CONSTRAINT "TA_BPE_RELATION_GEOM_FID_BPE_FK"
FOREIGN KEY ("FID_BPE")
REFERENCES "G_GEO.TA_BPE"("OBJECTID");

-- 3.4.2 vers la table G_GEO.TA_BPE_GEOM
ALTER TABLE G_GEO.TA_BPE_RELATION_GEOM
ADD CONSTRAINT "TA_BPE_RELATION_GEOM_FID_BPE_GEOM_FK"
FOREIGN KEY ("FID_BPE_GEOM")
REFERENCES "G_GEO.TA_BPE_GEOM"("OBJECTID");


-- 3.5 Création des index sur les cléfs étrangères.
CREATE INDEX ta_bpe_relation_geom_fid_bpe_IDX ON G_GEO.TA_BPE_RELATION_GEOM(fid_bpe)
    TABLESPACE G_ADT_INDX;

CREATE INDEX ta_bpe_relation_geom_fid_bpe_geom_IDX ON G_GEO.TA_BPE_RELATION_GEOM(fid_bpe_geom)
    TABLESPACE G_ADT_INDX;


-- 4. Création de la table G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE
-- Creation de la table G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE pour faire la liaison entre un equipement de la BPE vers ses caractéristiques numerique.

-- 4.1 Création de la table
CREATE TABLE G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE(
	objectid NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    fid_bpe NUMBER(38,0),
    fid_libelle NUMBER(38,0),
    nombre NUMBER(38,0)
	);


-- 4.2 Création des commentaires
COMMENT ON TABLE G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE IS 'Table de relation entre les equipements et les libelles ou l''information et sous la forme d''un nombre: exemple NB_SALLES: 4. L''équipement dispose de 4 salles';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE.objectid IS 'Clé primaire de la table G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE.';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE.fid_bpe IS 'Clé étrangère vers la table G_GEO.TA_BPE';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE.fid_libelle IS 'Clé étrangère vers la table G_GEO.TA_LIBELLE pour connaitre la caractéristique de l''équipement';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE.nombre IS 'Nombre de salles de théatre par cinéma, théatre ou nombre d''aires de pratique d''un même type au sein de l''équipement';


-- 4.3 Création de la clé primaire
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE
ADD CONSTRAINT ta_bpe_caracteristique_quantitative_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 4.4 clé étrangère

-- 4.4.1 clé étrangère vers la table G_GEO.TA_BPE
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE
ADD CONSTRAINT  "TA_BPE_CARACTERISTIQUE_QUANTITATIVE_FID_BPE_FK"
FOREIGN KEY ("FID_BPE")
REFERENCES  "G_GEO.TA_BPE" ("OBJECTID");

-- 4.4.2 clé étrangère vers la table TA_LIBELLE pour connaitre la caractéristique de l'equipement
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE
ADD CONSTRAINT  "TA_BPE_CARACTERISTIQUE_QUANTITATIVE_FID_LIBELLE_FK"
FOREIGN KEY ("FID_LIBELLE")
REFERENCES  "TA_LIBELLE" ("OBJECTID");


-- 4.5 Création des index sur les cléfs étrangères.

CREATE INDEX ta_bpe_caracteristique_quantitative_fid_bpe_IDX ON G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE(fid_bpe)
    TABLESPACE G_ADT_INDX;

CREATE INDEX ta_bpe_caracteristique_quantitative_fid_libelle_IDX ON G_GEO.TA_BPE_CARACTERISTIQUE_QUANTITATIVE(fid_libelle)
    TABLESPACE G_ADT_INDX;


-- 5 Création de la table G_GEO.TA_BPE_CARACTERISTIQUE
-- Creation de la table G_GEO.TA_BPE_CARACTERISTIQUE pour faire la liaison entre un equipement de la BPE vers ses caractéristiques.

-- 5.1 Création de la table
CREATE TABLE G_GEO.TA_BPE_CARACTERISTIQUE(
	objectid NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    fid_bpe NUMBER(38,0),
    fid_libelle NUMBER(38,0)
	);


-- 5.2 Création des commentaires
COMMENT ON TABLE G_GEO.TA_BPE_CARACTERISTIQUE IS 'Table de relation entre les equipements et les libelles pour connaitre les caractéristiques des équipements';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE.objectid IS 'Clé primaire de la table G_GEO.TA_BPE_CARACTERISTIQUE.';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE.fid_bpe IS 'Clé étrangère vers la table G_GEO.TA_BPE';
COMMENT ON COLUMN G_GEO.TA_BPE_CARACTERISTIQUE.fid_libelle IS 'Clé étrangère vers la table TA_LIBELLE pour connaitre la caractéristique de l''equipement';


-- 5.3 Création de la clé primaire
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE
ADD CONSTRAINT ta_bpe_caracteristique_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 5.4 clé étrangère

-- 5.4.1 clé étrangère vers la table G_GEO.TA_BPE
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE
ADD CONSTRAINT "TA_BPE_CARACTERISTIQUE_FID_BPE_FK"
FOREIGN KEY ("FID_BPE")
REFERENCES "G_GEO.TA_BPE" ("OBJECTID");

-- 5.4.2 clé étrangère vers la table TA_LIBELLE pour connaitre la caractéristique de l'equipement
ALTER TABLE G_GEO.TA_BPE_CARACTERISTIQUE
ADD CONSTRAINT "TA_BPE_CARACTERISTIQUE_FID_LIBELLE_FK"
FOREIGN KEY ("FID_LIBELLE")
REFERENCES "TA_LIBELLE" ("OBJECTID");


-- 5.5 Création des index sur les clés étrangères.

CREATE INDEX ta_bpe_caracteristique_fid_bpe_IDX ON G_GEO.TA_BPE_CARACTERISTIQUE(fid_bpe)
    TABLESPACE G_ADT_INDX;

CREATE INDEX ta_bpe_caracteristique_fid_libelle_fils_IDX ON G_GEO.TA_BPE_CARACTERISTIQUE(fid_libelle)
    TABLESPACE G_ADT_INDX;


-- 6. Creation de la table G_GEO.TA_BPE_RELATION_CODE
-- Création de la table G_GEO.TA_BPE_RELATION_CODE, table de relation entre les équipements et les codes insee des communes ainsi que les codes IRIS d'implantation.

-- 6.1 Création de la table
CREATE TABLE G_GEO.TA_BPE_RELATION_CODE(
    fid_bpe NUMBER(38,0),
    fid_code NUMBER(38,0)
    );


-- 6.2 Création des commentaires
COMMENT ON TABLE G_GEO.TA_BPE_RELATION_CODE IS 'Table regroupant les equipements de la Base Permanente des Equipements et leurs code d''INSEE et IRIS.';
COMMENT ON COLUMN G_GEO.TA_BPE_RELATION_CODE.fid_bpe IS 'Clé primaire de la table G_GEO.TA_BPE pour connaitre l''identifiant de l''équipement BPE.';
COMMENT ON COLUMN G_GEO.TA_BPE_RELATION_CODE.fid_code IS 'Clé étrangère vers la table TA_CODE pour connaitre les codes insee des communes ainsi que les codes IRIS des zones IRIS d''implantation de l''équipement';


-- 6.3 Création de la clé primaire.
ALTER TABLE G_GEO.TA_BPE_RELATION_CODE
ADD CONSTRAINT ta_bpe_relation_code_PK 
PRIMARY KEY("FID_BPE","FID_CODE")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 6.4. Création des clés étrangères
-- 6.4.1. Création de la clé étrangère vers la table ta_libelle pour connaitre le BPE concerné par le code.
ALTER TABLE G_GEO.TA_BPE_RELATION_CODE
ADD CONSTRAINT  "TA_BPE_RELATION_CODE_FID_BPE_FK"
FOREIGN KEY ("FID_BPE")
REFERENCES  "G_GEO.TA_BPE" ("OBJECTID");

-- 6.4.2. Création de la clé étrangère vers la table ta_libelle pour connaitre le code de la commune d'implantation de l'équipement.
ALTER TABLE G_GEO.TA_BPE_RELATION_CODE
ADD CONSTRAINT  "TA_BPE_RELATION_CODE_FID_CODE_FK"
FOREIGN KEY ("FID_CODE")
REFERENCES  "TA_CODE" ("OBJECTID");