-- CREATION DE LA STRUCTURE OSM

-- 1. CREATION DE LA TABLE TA_OSM_GEOM

CREATE TABLE G_OSM.TA_OSM_GEOM(
	OBJECTID NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    GEOM SDO_GEOMETRY
	);

-- 1.2 Création des commentaires
COMMENT ON TABLE G_OSM.TA_OSM_GEOM IS 'Table regroupant les polygones OSM';
COMMENT ON COLUMN G_OSM.TA_OSM_GEOM.objectid IS 'Clé primaire de la table G_OSM.TA_OSM_GEOM.';
COMMENT ON COLUMN G_OSM.TA_OSM_GEOM.GEOM IS 'Géométrie que peuvent prendre les éléments OSM.';


-- 1.3 Création de la clé primaire
ALTER TABLE G_OSM.TA_OSM_GEOM
ADD CONSTRAINT TA_OSM_GEOM_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";


-- 1.4 Création des métadonnées spatiales
INSERT INTO USER_SDO_GEOM_METADATA(
    TABLE_NAME, 
    COLUMN_NAME, 
    DIMINFO, 
    SRID
)
VALUES(
    'TA_OSM_GEOM',
    'GEOM',
    SDO_DIM_ARRAY(SDO_DIM_ELEMENT('X', 684540, 719822.2, 0.005),SDO_DIM_ELEMENT('Y', 7044212, 7078072, 0.005)), 
    2154
);


-- 1.5 Création de l'index spatial sur le champ geom
CREATE INDEX TA_OSM_GEOM_SIDX
ON TA_OSM_GEOM(GEOM)
INDEXTYPE IS MDSYS.SPATIAL_INDEX
PARAMETERS('sdo_indx_dims=2, layer_gtype=MULTIPOLYGON, tablespace=G_ADT_INDX, work_tablespace=DATA_TEMP');


-- 2. CREATION DE LA TABLE TA_OSM_POINT_GEOM

-- 2.1 Création de la table
CREATE TABLE G_OSM.TA_OSM_POINT_GEOM(
    OBJECTID NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    GEOM SDO_GEOMETRY
    );

-- 2.2 Création des commentaires
COMMENT ON TABLE G_OSM.TA_OSM_POINT_GEOM IS 'Table regroupant les points OSM';
COMMENT ON COLUMN G_OSM.TA_OSM_POINT_GEOM.objectid IS 'Clé primaire de la table G_OSM.TA_OSM_POINT_GEOM.';
COMMENT ON COLUMN G_OSM.TA_OSM_POINT_GEOM.GEOM IS 'Géométrie que peuvent prendre les éléments points OSM.';

-- 2.3 Création de la clé primaire
ALTER TABLE G_OSM.TA_OSM_POINT_GEOM
ADD CONSTRAINT TA_OSM_POINT_GEOM_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";

-- 2.4 Création des métadonnées spatiales
INSERT INTO USER_SDO_GEOM_METADATA(
    TABLE_NAME, 
    COLUMN_NAME, 
    DIMINFO, 
    SRID
)
VALUES(
    'TA_OSM_POINT_GEOM',
    'GEOM',
    SDO_DIM_ARRAY(SDO_DIM_ELEMENT('X', 684540, 719822.2, 0.005),SDO_DIM_ELEMENT('Y', 7044212, 7078072, 0.005)), 
    2154
);

-- 2.5 Création de l'index spatial sur le champ geom
CREATE INDEX TA_OSM_POINT_GEOM_SIDX
ON TA_OSM_POINT_GEOM(GEOM)
INDEXTYPE IS MDSYS.SPATIAL_INDEX
PARAMETERS('sdo_indx_dims=2, layer_gtype=POINT, tablespace=G_ADT_INDX, work_tablespace=DATA_TEMP');


-- 3. CREATION DE LA TABLE TA_OSM

-- 3. Creation de la table G_OSM.TA_OSM
-- Création de la table G_OSM.TA_OSM qui recense les multipolygones OSM
-- 3.1 Création de la table
CREATE TABLE G_OSM.TA_OSM(
    OBJECTID NUMBER(38,0) GENERATED BY DEFAULT AS IDENTITY START WITH 1 INCREMENT BY 1,
    FID_METADONNEE NUMBER(38,0)
    );

-- 3.2 Création des commentaires
COMMENT ON TABLE G_OSM.TA_OSM IS 'Table regroupant les éléménts issues de la base OSM.';
COMMENT ON COLUMN G_OSM.TA_OSM.objectid IS 'Clé primaire de la table G_OSM.TA_OSM.';
COMMENT ON COLUMN G_OSM.TA_OSM.fid_metadonnee IS 'Clé étrangère vers la table G_OSM.TA_METADONNEE pour connaitre la source de la données.';

-- 3.3 Création de la clé primaire
ALTER TABLE G_OSM.TA_OSM
ADD CONSTRAINT TA_OSM_PK 
PRIMARY KEY("OBJECTID")
USING INDEX TABLESPACE "G_ADT_INDX";

-- 3.4 Création des clés étrangères

-- 3.4.1 Création de la clé étrangère vers la table ta_metadonnée
ALTER TABLE G_OSM.TA_OSM
ADD CONSTRAINT  "TA_OSM_FID_METADONNEE_FK"
FOREIGN KEY ("FID_METADONNEE")
REFERENCES  "TA_METADONNEE" ("OBJECTID");

-- 3.5 Création des index sur les cléfs étrangères.
CREATE INDEX TA_OSM_fid_metadonnee_IDX ON G_OSM.TA_OSM(fid_metadonnee)
TABLESPACE G_ADT_INDX;

-- 4. Création de la table G_OSM.TA_OSM_RELATION_GEOM
-- Creation de la table G_OSM.TA_OSM_RELATION_GEOM, table de correspondance entre les identifiants OSM et leurs géométries.

-- 4.1 Creation de la table
CREATE TABLE G_OSM.TA_OSM_RELATION_GEOM(
	fid_osm NUMBER(38,0),
	fid_osm_geom NUMBER(38,0)
	);

-- 4.2 Création des commentaires des colonnes
COMMENT ON TABLE G_OSM.TA_OSM_RELATION_GEOM IS 'Table de liaison entre les éléments issus de la base OSM et leurs géométries.';
COMMENT ON COLUMN G_OSM.TA_OSM_RELATION_GEOM.fid_osm IS 'Clé étrangère vers la table G_OSM.TA_OSM. Composante de la clé primaire.';
COMMENT ON COLUMN G_OSM.TA_OSM_RELATION_GEOM.fid_osm_geom IS 'Clé étrangère vers la table G_OSM.TA_OSM_GEOM. Composante de la clé primaire.';

-- 4.3 Ajout de la clé primaire
ALTER TABLE G_OSM.TA_OSM_RELATION_GEOM
ADD CONSTRAINT TA_OSM_RELATION_GEOM_PK 
PRIMARY KEY(fid_osm,fid_osm_geom)
USING INDEX TABLESPACE "G_ADT_INDX";

-- 4.4 Création des clés étrangères

-- 4.4.1 vers la table G_OSM.TA_ODM
ALTER TABLE G_OSM.TA_OSM_RELATION_GEOM
ADD CONSTRAINT "TA_OSM_RELATION_GEOM_FID_OSM_FK"
FOREIGN KEY ("FID_OSM")
REFERENCES "TA_OSM"("OBJECTID");

-- 4.4.2 vers la table G_OSM.TA_OSM_GEOM
ALTER TABLE G_OSM.TA_OSM_RELATION_GEOM
ADD CONSTRAINT "TA_OSM_RELATION_GEOM_FID_OSM_GEOM_FK"
FOREIGN KEY ("FID_OSM_GEOM")
REFERENCES "TA_OSM_GEOM"("OBJECTID");


-- 4.5 Création des index sur les cléfs étrangères.
CREATE INDEX TA_OSM_RELATION_GEOM_FID_OSM_IDX ON G_OSM.TA_OSM_RELATION_GEOM(fid_osm)
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_OSM_RELATION_GEOM_FID_OSM_GEOM_IDX ON G_OSM.TA_OSM_RELATION_GEOM(fid_osm_geom)
    TABLESPACE G_ADT_INDX;

-- 5. Création de la table G_OSM.TA_OSM_RELATION_POINT_GEOM
-- Creation de la table G_OSM.TA_OSM_RELATION_POINT_GEOM, table de correspondance entre les identifiants OSM et leurs géométries.

-- 5.1 Creation de la table
CREATE TABLE G_OSM.TA_OSM_RELATION_POINT_GEOM(
    fid_osm NUMBER(38,0),
    fid_osm_point_geom NUMBER(38,0)
    );

-- 5.2 Création des commentaires des colonnes
COMMENT ON TABLE G_OSM.TA_OSM_RELATION_POINT_GEOM IS 'Table de liaison entre les éléments issus de la base OSM et leurs géométries de type point.';
COMMENT ON COLUMN G_OSM.TA_OSM_RELATION_POINT_GEOM.fid_osm IS 'Clé étrangère vers la table G_OSM.TA_OSM. Composante de la clé primaire.';
COMMENT ON COLUMN G_OSM.TA_OSM_RELATION_POINT_GEOM.fid_osm_point_geom IS 'Clé étrangère vers la table G_OSM.TA_OSM_POINT_GEOM. Composante de la clé primaire.';

-- 5.3 Ajout de la clé primaire
ALTER TABLE G_OSM.TA_OSM_RELATION_POINT_GEOM
ADD CONSTRAINT TA_OSM_RELATION_POINT_GEOM_PK 
PRIMARY KEY(fid_osm,fid_osm_point_geom)
USING INDEX TABLESPACE "G_ADT_INDX";

-- 5.4 Création des clés étrangères

-- 5.4.1 vers la table G_OSM.TA_OSM
ALTER TABLE G_OSM.TA_OSM_RELATION_POINT_GEOM
ADD CONSTRAINT "TA_OSM_RELATION_POINT_GEOM_FID_OSM_FK"
FOREIGN KEY ("FID_OSM")
REFERENCES "TA_OSM"("OBJECTID");

-- 5.4.2 vers la table G_OSM.TA_OSM_POINT_GEOM
ALTER TABLE G_OSM.TA_OSM_RELATION_POINT_GEOM
ADD CONSTRAINT "TA_OSM_RELATION_POINT_GEOM_FID_OSM_POINT_GEOM_FK"
FOREIGN KEY ("FID_OSM_POINT_GEOM")
REFERENCES "TA_OSM_POINT_GEOM"("OBJECTID");


-- 5.5 Création des index sur les cléfs étrangères.
CREATE INDEX TA_OSM_RELATION_POINT_GEOM_FID_OSM_IDX ON G_OSM.TA_OSM_RELATION_POINT_GEOM(fid_osm)
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_OSM_RELATION_POINT_GEOM_fid_osm_point_geom_IDX ON G_OSM.TA_OSM_RELATION_POINT_GEOM(fid_osm_point_geom)
    TABLESPACE G_ADT_INDX;

-- 5. CREATION DE LA TABLE TA_OSM_CARACTERISTIQUE

-- 5.1 Création de la table
CREATE TABLE G_OSM.TA_OSM_CARACTERISTIQUE(
    OBJECTID NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    FID_OSM NUMBER(38,0),
    KEY VARCHAR2(4000),
    VALEUR VARCHAR2(4000)
    );

-- 5.2 Création des commentaires des colonnes
COMMENT ON TABLE G_OSM.TA_OSM_CARACTERISTIQUE IS 'Table permettant de connaitre les caractéristiques d''un élément OSM. EXEMPLE: AMENITY -> PARKING';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE.OBJECTID IS 'Clé primaire de la table.';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE.FID_OSM IS 'Clé étrangère vers la table G_OSM.TA_OSM. Afin de connaitre les caractéristiques d''un élément OSM.';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE.KEY IS 'KEY OSM. Mot clé dans la terminologie OSM. EXEMPLE: AMENITY';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE.VALEUR IS 'Valeur que peut prendre une clé OSM. EXEMPLE: PARKING';

-- 5.3 Ajout de la clé primaire
ALTER TABLE G_OSM.TA_OSM_CARACTERISTIQUE
ADD CONSTRAINT TA_OSM_CARACTERISTIQUE_PK 
PRIMARY KEY(OBJECTID)
USING INDEX TABLESPACE "G_ADT_INDX";


-- 5.4 vers la table G_OSM.TA_OSM
ALTER TABLE G_OSM.TA_OSM_CARACTERISTIQUE
ADD CONSTRAINT "TA_OSM_CARACTERISTIQUE_FID_OSM_FK"
FOREIGN KEY ("FID_OSM")
REFERENCES "TA_OSM"("OBJECTID");

-- 5.5 Création des index sur les cléfs étrangères.
CREATE INDEX TA_OSM_CARACTERISTIQUE_KEY_IDX ON G_OSM.TA_OSM_CARACTERISTIQUE(KEY)
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_OSM_CARACTERISTIQUE_VALEUR_IDX ON G_OSM.TA_OSM_CARACTERISTIQUE(VALEUR)
    TABLESPACE G_ADT_INDX;

-- 6. CREATION DE LA TABLE TA_OSM_CARACTERISTIQUE_QUANTITATIVE

-- 6.1 Création de la table
CREATE TABLE G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE(
    OBJECTID NUMBER(38,0) GENERATED ALWAYS AS IDENTITY START WITH 1 INCREMENT BY 1,
    FID_OSM NUMBER(38,0),
    KEY VARCHAR2(4000),
    VALEUR NUMBER(38)
    );

-- 6.2 Création des commentaires des colonnes
COMMENT ON TABLE G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE IS 'Table permettant de connaitre les caractéristiques d''un élément OSM. EXEMPLE: AMENITY -> PARKING';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE.OBJECTID IS 'Clé primaire de la table.';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE.FID_OSM IS 'Clé étrangère vers la table G_OSM.TA_OSM. Afin de connaitre les caractéristiques d''un élément OSM.';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE.KEY IS 'KEY OSM. Mot clé dans la terminologie OSM. EXEMPLE: AMENITY';
COMMENT ON COLUMN G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE.VALEUR IS 'Valeur que peut prendre une clé OSM. EXEMPLE: PARKING';

-- 6.3 Ajout de la clé primaire
ALTER TABLE G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE
ADD CONSTRAINT TA_OSM_CARACTERISTIQUE_QUANTITATIVE_PK 
PRIMARY KEY(OBJECTID)
USING INDEX TABLESPACE "G_ADT_INDX";


-- 6.4 vers la table G_OSM.TA_OSM
ALTER TABLE G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE
ADD CONSTRAINT "TA_OSM_CARACTERISTIQUE_QUANTITATIVE_FID_OSM_FK"
FOREIGN KEY ("FID_OSM")
REFERENCES "TA_OSM"("OBJECTID");

-- 6.5 Création des index sur les cléfs étrangères.
CREATE INDEX TA_OSM_CARACTERISTIQUE_QUANTITATIVE_KEY_IDX ON G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE(KEY)
    TABLESPACE G_ADT_INDX;

CREATE INDEX TA_OSM_CARACTERISTIQUE_QUANTITATIVE_VALEUR_IDX ON G_OSM.TA_OSM_CARACTERISTIQUE_QUANTITATIVE(VALEUR)
    TABLESPACE G_ADT_INDX;

