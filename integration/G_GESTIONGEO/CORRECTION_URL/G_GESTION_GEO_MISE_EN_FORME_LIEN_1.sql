-- REQUETE DE MISE EN FORME DE LA TABLE TEMP_LISTE_FICHIER_GESTION_GEO


-- 1. CREATION D UNE COLONNE DE CLE PRIMARE.
-- 1.1. SUPPRESSION DE LA COLONNE OBJECTID.

ALTER TABLE
    G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
DROP COLUMN
    OBJECTID;
COMMIT;


-- 1.2. SUPPRESSION DES LIGNES CONTENANT DES FICHIERS Thumbs.db.

DELETE
    FROM G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
WHERE
    LIEN LIKE '%Thumbs.db'
;
COMMIT;


-- 1.3. SUPPRESSION DE LA CONTRAINTE DE CLE PRIMAIRE.

SET SERVEROUTPUT ON
DECLARE
    v_nom_1 VARCHAR2(200);
BEGIN
SELECT
    CONSTRAINT_NAME
    INTO v_nom_1
FROM
    USER_CONSTRAINTS
WHERE
    TABLE_NAME = 'TEMP_LISTE_FICHIER_GESTION_GEO'
    AND CONSTRAINT_TYPE = 'P';
EXECUTE IMMEDIATE 'ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO DROP CONSTRAINT ' || v_nom_1;
END;
/
COMMIT;


-- 1.4. SUPPRESSION DE LA COLONNE OGR_FID.

 ALTER TABLE
    G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
DROP COLUMN
    OGR_FID;
COMMIT;


-- 1.5. AJOUT D'UNE COLONNE CLE PRIMAIRE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO ADD (OBJECTID INTEGER GENERATED BY DEFAULT AS IDENTITY 
    (
        START WITH 1 
        INCREMENT BY 1
        MAXVALUE 100000
        CACHE 10 
        CYCLE
    ));
COMMIT;


-- 2. CREATION DE LA COLONNE INTEGRATION.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (INTEGRATION NUMBER(34,0));
COMMIT;


-- 3. AJOUT DE LA COLONNE LIEN_MODIFIE POUR CORRIGE LES EXTENSIONS EN _XXX et NON .XXX
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_MODIFIE VARCHAR2(4000));
COMMIT;


-- 3.2. MISE A JOUR DE LA COLONNE LIEN_MODIFIE, CORRECTION DES EXTENSIONS
-- SI LES EXTENSIONS SONT NORMALES:
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        LIEN,
        CASE
            WHEN REGEXP_SUBSTR(SUBSTR(LIEN,-5,5), '[_]') IS NOT NULL
                THEN SUBSTR(LIEN,1,INSTR(LIEN,'_',-1,1)-1) || '.' || SUBSTR(LIEN,INSTR(LIEN,'_',-1,1)+1,LENGTH(LIEN))
            WHEN REGEXP_SUBSTR(SUBSTR(LIEN,-5,5), '[_]') IS NULL
                THEN
                CASE
                    WHEN REGEXP_COUNT(LIEN, '[.]', 1) = 1
                        THEN LIEN
                    ELSE REPLACE(SUBSTR(LIEN,1,INSTR(LIEN,'.',-1,1)-1),'.','_')||SUBSTR(LIEN,INSTR(LIEN,'.',-1,1),LENGTH(LIEN))
                END
        END LIEN_MODIFIE
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_MODIFIE = b.LIEN_MODIFIE
;


-- AJOUT DE LA COLONNE DOS_NUM
-- 3. CREATION DE LA COLONNE DOS_NUM POUR LA JOINTURE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (DOS_NUM NUMBER(34,0));
COMMIT;


-- 3.2. MISE A JOUR DE LA COLONNE DOS_NUM.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING (
       WITH CTE AS (
        SELECT
            OBJECTID,
            SUBSTR(
            LIEN_MODIFIE,
            1,
            INSTR(LIEN_MODIFIE,'\',-1)-1) AS LIEN_MODIFIE
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        )
        SELECT
            OBJECTID as OBJECTID_LIST,
            CAST (SUBSTR(
                SUBSTR(
                    LIEN_MODIFIE,
                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                    LENGTH(LIEN_MODIFIE)
                    ),
                1,
            INSTR(
                SUBSTR(
                    LIEN_MODIFIE,
                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                    LENGTH(LIEN_MODIFIE)
                    ),'_'
                    )-1
                    ) AS INTEGER) AS DOS_NUM_CORRIGE
        FROM
            CTE
        WHERE REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[0-9]')
        AND NOT REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[-]')
        AND NOT REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[A-Z]')
        )b
ON (a.OBJECTID = b.OBJECTID_LIST)
WHEN MATCHED THEN
UPDATE SET a.DOS_NUM = b.DOS_NUM_CORRIGE
;
COMMIT;


-- AJOUT DE LA COLONNE ID_DOS
-- 4. CREATION DE LA COLONNE ID_DOS POUR LA JOINTURE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (ID_DOS NUMBER(34,0));
COMMIT;


-- 4.2. MISE A JOUR DE LA COLONNE ID_DOS

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING (
        SELECT
            a.ID_DOS,
            a.DOS_NUM
        FROM
            G_GESTIONGEO.TEMP_TA_GG_DOSSIER a
        )b
ON (a.DOS_NUM = b.DOS_NUM)
WHEN MATCHED THEN
UPDATE SET a.ID_DOS = b.ID_DOS
;
COMMIT;


-- 5. AJOUT DE LA COLONNE DOSSIER
-- Contient les chemins et les noms des dossiers des dossiers GESTIONGEO
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (DOSSIER VARCHAR2(4000));
COMMIT;


-- 5.2. MISE A JOUR DE LA COLONNE DOSSIER
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET DOSSIER = SUBSTR(LIEN_MODIFIE,1,INSTR(LIEN_MODIFIE,'\',-1,1)-1);
COMMIT;


-- 6. AJOUT DE LA COLONNE NVX_LIEN
-- Chemin vers le nouveau repertoire des dossiers GESTIONGEO.
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (NVX_LIEN VARCHAR2(4000));
COMMIT;

-- 6.2. MISE A JOUR DE LA COLONNE NVX_LIEN
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
        SELECT
            OBJECTID,
            CASE
                WHEN ID_DOS IS NULL
                THEN '/var/www/extraction/apps/gestiongeo' || '/'
            ELSE
                '/var/www/extraction/apps/gestiongeo' || '/' || ID_DOS || '/'
            END NVX_LIEN
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.NVX_LIEN = b.NVX_LIEN
;
COMMIT;

-- 7. LIEN_RENOMMAGE_DOSSIER
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_DOSSIER VARCHAR2(4000));
COMMIT;


-- 7.2. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_DOSSIER

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    WITH CTE AS
        (
        SELECT
            OBJECTID,
            ID_DOS,
            SUBSTR(
                LIEN_MODIFIE,
                1,
                INSTR(LIEN_MODIFIE,'\',-1)-1
                ) AS LIEN_RENOMMAGE_DOSSIER
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        )
    SELECT
        OBJECTID,
        SUBSTR(CTE.LIEN_RENOMMAGE_DOSSIER,1,LENGTH(CTE.LIEN_RENOMMAGE_DOSSIER)-(LENGTH(CTE.LIEN_RENOMMAGE_DOSSIER)-INSTR(CTE.LIEN_RENOMMAGE_DOSSIER,'\',-1))) || CTE.ID_DOS AS LIEN_RENOMMAGE_DOSSIER
    FROM
        CTE
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_DOSSIER = b.LIEN_RENOMMAGE_DOSSIER
;
COMMIT;


-- 8. AJOUT DE LA COLONNE LIEN_RENOMMAGE_FICHIER
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_FICHIER VARCHAR2(4000));
COMMIT;


-- 8.1. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_FICHIER pour les dossier avec une geometrie.

MERGE INTO TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    WITH CTE AS
        (
        SELECT
            a.ID_GEOM,
            a.ID_DOS,
            a.ETAT_ID,
            a.DOS_NUM,
            a.SURFACE,
            SDO_GEOM.SDO_INTERSECTION(a.GEOM,b.GEOM) AS GEOM
        FROM
            G_GESTIONGEO.TA_GG_GEO a,
            G_REFERENTIEL.MEL b
        )
    SELECT 
        a.OBJECTID,
        a.ID_DOS,
        a.DOS_NUM,
        a.LIEN_MODIFIE,
        d.NOM,
        a.OBJECTID || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_') || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE,'.'),LENGTH(a.LIEN_MODIFIE)) AS FICHIER,
        a.DOSSIER || '\' || a.OBJECTID || '_' || d.CODE_INSEE || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_') || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE, '.', -1, 1),LENGTH(a.LIEN_MODIFIE)) AS LIEN_RENOMMAGE_FICHIER
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a 
        INNER JOIN G_GESTIONGEO.TA_GG_DOSSIER b ON a.ID_DOS = b.ID_DOS
        INNER JOIN CTE ON b.ID_DOS = CTE.ID_DOS,
        G_REFERENTIEL.MEL_COMMUNE d,
        G_REFERENTIEL.MEL e
    WHERE
        SDO_CONTAINS(d.GEOM, SDO_GEOM.SDO_POINTONSURFACE(CTE.GEOM)) = 'TRUE'
    AND
        a.ID_DOS IN (
                        SELECT
                            ID_DOS
                        FROM
                            G_GESTIONGEO.TA_GG_GEO
                    )
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;


-- 8.2. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_FICHIER avec geometrie mais operateur spatial touch

MERGE INTO TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    WITH CTE AS
        (
        SELECT
            a.ID_GEOM,
            a.ID_DOS,
            a.ETAT_ID,
            a.DOS_NUM,
            a.SURFACE,
            SDO_GEOM.SDO_INTERSECTION(a.GEOM,b.GEOM) AS GEOM
        FROM
            G_GESTIONGEO.TA_GG_GEO a,
            G_REFERENTIEL.MEL b
        )
    SELECT 
        a.OBJECTID,
        a.ID_DOS,
        a.DOS_NUM,
        a.LIEN_MODIFIE,
        d.NOM,
        a.OBJECTID || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_') || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE,'.'),LENGTH(a.LIEN_MODIFIE)) AS FICHIER,
        a.DOSSIER || '\' || a.OBJECTID || '_' || d.CODE_INSEE || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_') || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE, '.', -1, 1),LENGTH(a.LIEN_MODIFIE)) AS LIEN_RENOMMAGE_FICHIER
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a 
        INNER JOIN G_GESTIONGEO.TA_GG_DOSSIER b ON a.ID_DOS = b.ID_DOS
        INNER JOIN CTE ON b.ID_DOS = CTE.ID_DOS,
        G_REFERENTIEL.MEL_COMMUNE d,
        G_REFERENTIEL.MEL e
    WHERE
        SDO_TOUCH(d.GEOM, SDO_GEOM.SDO_POINTONSURFACE(CTE.GEOM)) = 'TRUE'
    AND
        a.ID_DOS IN (
                        SELECT
                            ID_DOS
                        FROM
                            G_GESTIONGEO.TA_GG_GEO
                    )
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;


-- 8.3. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_FICHIER pour les dossier sans geometrie.

MERGE INTO TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT 
        a.OBJECTID,
        a.ID_DOS,
        a.DOS_NUM,
        a.LIEN,
        d.NOM,
        a.OBJECTID || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_') || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE,'.'),LENGTH(a.LIEN_MODIFIE)) AS FICHIER,
        a.DOSSIER || '\' || a.OBJECTID || '_' || d.CODE_INSEE || '_' || REGEXP_REPLACE(d.NOM, ' |-|''' , '_')  || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE, '.', -1, 1),LENGTH(a.LIEN_MODIFIE)) AS LIEN_RENOMMAGE_FICHIER
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a 
        INNER JOIN G_GESTIONGEO.TA_GG_DOSSIER b ON a.ID_DOS = b.ID_DOS
        INNER JOIN G_REFERENTIEL.MEL_COMMUNE d ON d.CODE_INSEE = SUBSTR(a.LIEN_MODIFIE,INSTR(a.LIEN_MODIFIE,'_',1,4)+1,5)
    WHERE
        a.ID_DOS NOT IN (
                            SELECT
                                ID_DOS
                            FROM
                                G_GESTIONGEO.TA_GG_GEO
                        )
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;

-- 8.4
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        LIEN_MODIFIE AS LIEN_RENOMMAGE_FICHIER
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;
COMMIT;


-- 9. LIEN_RENOMMAGE_FICHIER_BASE

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_FICHIER_BASE VARCHAR2(4000));
COMMIT;


-- 9.1. LIEN_RENOMMAGE_FICHIER_BASE

-- 9.1.1. DANS LE CAS OU UN ID_DOS EST PRESENT
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT 
        a.OBJECTID,
        a.NVX_LIEN || SUBSTR(a.LIEN_RENOMMAGE_FICHIER,INSTR(a.LIEN_RENOMMAGE_FICHIER,'\',-1,1)+1,LENGTH(a.LIEN_RENOMMAGE_FICHIER)) AS LIEN_RENOMMAGE_FICHIER_BASE
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
    WHERE
        a.ID_DOS IS NOT NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER_BASE = b.LIEN_RENOMMAGE_FICHIER_BASE
;
COMMIT;

-- 9.1.2.
-- Dans le cas ou il n''y a pas ID_DOS
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        CASE
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\RECOL\%' AND ID_DOS IS NULL
            THEN
                REPLACE(REPLACE(LIEN_MODIFIE, 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\RECOL\', NVX_LIEN),'\','/')
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\IC\%' AND ID_DOS IS NULL
            THEN
                REPLACE(REPLACE(LIEN_MODIFIE, 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\IC\', NVX_LIEN),'\','/')
        END LIEN_RENOMMAGE_FICHIER_BASE
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER_BASE = b.LIEN_RENOMMAGE_FICHIER_BASE
;
COMMIT;


-- 10. MISE A JOUR LE COLONNE INTEGRATION.

-- 10.1. MISE A 1 DE LA COLONNE POUR LES DOSSIERS OU UN SEUL FICHIER EST PRESENT.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IN
        (SELECT ID_DOS FROM (
        (
        SELECT
            COUNT(ID_DOS),
            ID_DOS
        FROM
            (
            SELECT
                ID_DOS
            FROM
                G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
            WHERE
                UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) IN ('DWG','DXF')
            )
        GROUP BY
            ID_DOS
        HAVING COUNT(ID_DOS) = 1
        )))
    AND
        UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) IN ('DWG','DXF')
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED
THEN UPDATE SET INTEGRATION =1
;
COMMIT;

-- 10.2. MISE A 0 DE LA COLONNE INTEGRATION POUR LES DOSSIERS OU LES AUTRES FICHIERS D UN DOSSIER OU UN FICHIER EST DEJA A 1.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE ID_DOS
        IN 
        (
        SELECT
            ID_DOS
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        WHERE
            INTEGRATION =1      
        )
    AND UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) NOT IN ('DWG','DXF')
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED
THEN UPDATE SET INTEGRATION =0
;
COMMIT;

-- 10.3. MISE A 0 DE LA COLONNE INTEGRATION POUR LES ELEMENTS QUI NE SONT NI DES FICHIERS DWG OU DXF.

UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
SET INTEGRATION = 0
WHERE UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) NOT IN ('DWG','DXF');
COMMIT;


-- 11. MERGE AVEC LA TABLE G_GESTIONGEO.TA_GG_URL_FILE.
-- 11.1. Dans le cas ou il y a un ID_DOS
MERGE INTO G_GESTIONGEO.TEMP_GG_URL_FILE a
USING (
    SELECT
        ID_DOS AS FID_DOSSIER,
        LIEN_RENOMMAGE_FICHIER_BASE AS DOS_URL_FILE,
        INTEGRATION AS INTEGRATION
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NOT NULL
    )b
ON (a.FID_DOSSIER = b.FID_DOSSIER
AND a.DOS_URL_FILE = b.DOS_URL_FILE)
WHEN NOT MATCHED THEN
INSERT (a.FID_DOSSIER, a.DOS_URL_FILE, a.INTEGRATION)
VALUES (b.FID_DOSSIER, b.DOS_URL_FILE, b.INTEGRATION)
;
COMMIT;