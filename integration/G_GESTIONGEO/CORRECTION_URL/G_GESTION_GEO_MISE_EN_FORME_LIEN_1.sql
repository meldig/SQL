-- REQUETE DE MISE EN FORME DE LA TABLE TEMP_LISTE_FICHIER_GESTION_GEO


-- 1. CREATION D UNE COLONNE DE CLE PRIMARE.
-- 1.1. SUPPRESSION DE LA COLONNE OBJECTID.

ALTER TABLE
    G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
DROP COLUMN
    OBJECTID;
COMMIT;


-- 1.3. SUPPRESSION DE LA CONTRAINTE DE CLE PRIMAIRE.

SET SERVEROUTPUT ON
DECLARE
    v_nom_1 VARCHAR2(200);
BEGIN
SELECT
    CONSTRAINT_NAME
    INTO v_nom_1
FROM
    USER_CONSTRAINTS
WHERE
    TABLE_NAME = 'TEMP_LISTE_FICHIER_GESTION_GEO'
    AND CONSTRAINT_TYPE = 'P';
EXECUTE IMMEDIATE 'ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO DROP CONSTRAINT ' || v_nom_1;
END;
/
COMMIT;


-- 1.4. SUPPRESSION DE LA COLONNE OGR_FID.

ALTER TABLE
    G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
DROP COLUMN
    OGR_FID;
COMMIT;


-- 1.5. AJOUT D'UNE COLONNE CLE PRIMAIRE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO ADD (OBJECTID INTEGER GENERATED BY DEFAULT AS IDENTITY 
    (
        START WITH 1 INCREMENT BY 1
    ));
COMMIT;

-- 2. CREATION DE LA COLONNE INTEGRATION.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (INTEGRATION NUMBER(34,0));
COMMIT;


-- 3. LIEN_MODIFIE POUR CORRIGE LES EXTENSIONS EN _XXX et NON .XXX
-- 3.1. AJOUT DE LA COLONNE LIEN_MODIFIE POUR CORRIGE LES EXTENSIONS EN _XXX et NON .XXX
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_MODIFIE VARCHAR2(4000));
COMMIT;


-- 3.2. MISE A JOUR DE LA COLONNE LIEN_MODIFIE, CORRECTION DES EXTENSIONS
-- SI LES EXTENSIONS SONT NORMALES:
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        LIEN,
        CASE
            WHEN REGEXP_SUBSTR(SUBSTR(LIEN,-5,5), '[_]') IS NOT NULL
                THEN SUBSTR(LIEN,1,INSTR(LIEN,'_',-1,1)-1) || '.' || SUBSTR(LIEN,INSTR(LIEN,'_',-1,1)+1,LENGTH(LIEN))
            WHEN REGEXP_SUBSTR(SUBSTR(LIEN,-5,5), '[_]') IS NULL
                THEN
                CASE
                    WHEN REGEXP_COUNT(LIEN, '[.]', 1) = 1
                        THEN LIEN
                    ELSE REPLACE(SUBSTR(LIEN,1,INSTR(LIEN,'.',-1,1)-1),'.','_')||SUBSTR(LIEN,INSTR(LIEN,'.',-1,1),LENGTH(LIEN))
                END
        END LIEN_MODIFIE
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_MODIFIE = b.LIEN_MODIFIE
;


-- 4. AJOUT DE LA COLONNE DOS_NUM
-- 4.1. CREATION DE LA COLONNE DOS_NUM POUR LA JOINTURE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (DOS_NUM NUMBER(34,0));
COMMIT;


-- 4.2. MISE A JOUR DE LA COLONNE DOS_NUM.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING (
       WITH CTE AS (
        SELECT
            OBJECTID,
            SUBSTR(
            LIEN_MODIFIE,
            1,
            INSTR(LIEN_MODIFIE,'\',-1)-1) AS LIEN_MODIFIE
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        )
        SELECT
            OBJECTID as OBJECTID_LIST,
            CAST (SUBSTR(
                SUBSTR(
                    LIEN_MODIFIE,
                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                    LENGTH(LIEN_MODIFIE)
                    ),
                1,
            INSTR(
                SUBSTR(
                    LIEN_MODIFIE,
                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                    LENGTH(LIEN_MODIFIE)
                    ),'_'
                    )-1
                    ) AS INTEGER) AS DOS_NUM_CORRIGE
        FROM
            CTE
        WHERE REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[0-9]')
        AND NOT REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[-]')
        AND NOT REGEXP_LIKE (
                           SUBSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),
                                1,
                            INSTR(
                                SUBSTR(
                                    LIEN_MODIFIE,
                                    INSTR(LIEN_MODIFIE,'\',-1)+1,
                                    LENGTH(LIEN_MODIFIE)
                                    ),'_'
                                    )-1
                                    ),'[A-Z]')
        )b
ON (a.OBJECTID = b.OBJECTID_LIST)
WHEN MATCHED THEN
UPDATE SET a.DOS_NUM = b.DOS_NUM_CORRIGE
;
COMMIT;


-- AJOUT DE LA COLONNE ID_DOS
-- 5. CREATION DE LA COLONNE ID_DOS POUR LA JOINTURE.

ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (ID_DOS NUMBER(34,0));
COMMIT;


-- 5.2. MISE A JOUR DE LA COLONNE ID_DOS

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING (
        SELECT
            a.OBJECTID AS ID_DOS,
            b.DOS_NUM
        FROM
            G_GESTIONGEO.TA_GG_DOSSIER a
            INNER JOIN G_GESTIONGEO.TA_GG_DOS_NUM b ON a.OBJECTID = b.FID_DOSSIER 
        )b
ON (a.DOS_NUM = b.DOS_NUM)
WHEN MATCHED THEN
UPDATE SET a.ID_DOS = b.ID_DOS
;
COMMIT;


-- 6. AJOUT DE LA COLONNE DOSSIER
-- Contient les chemins et les noms des dossiers des dossiers GESTIONGEO
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (DOSSIER VARCHAR2(4000));
COMMIT;


-- 6.2. MISE A JOUR DE LA COLONNE DOSSIER
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET DOSSIER = SUBSTR(LIEN,1,INSTR(LIEN,'\',-1,1)-1);
COMMIT;


-- 7. LIEN_RENOMMAGE_DOSSIER
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_DOSSIER VARCHAR2(4000));
COMMIT;


-- 7.2. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_DOSSIER

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    WITH CTE AS
        (
        SELECT
            OBJECTID,
            ID_DOS,
            SUBSTR(
                LIEN_MODIFIE,
                1,
                INSTR(LIEN_MODIFIE,'\',-1)-1
                ) AS LIEN_RENOMMAGE_DOSSIER
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        )
    SELECT
        OBJECTID,
        SUBSTR(CTE.LIEN_RENOMMAGE_DOSSIER,1,LENGTH(CTE.LIEN_RENOMMAGE_DOSSIER)-(LENGTH(CTE.LIEN_RENOMMAGE_DOSSIER)-INSTR(CTE.LIEN_RENOMMAGE_DOSSIER,'\',-1))) || CTE.ID_DOS AS LIEN_RENOMMAGE_DOSSIER
    FROM
        CTE
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_DOSSIER = b.LIEN_RENOMMAGE_DOSSIER
;
COMMIT;


-- 8. AJOUT DE LA COLONNE LIEN_RENOMMAGE_FICHIER
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_FICHIER VARCHAR2(4000));
COMMIT;


-- 8.1. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_FICHIER pour les dossier avec une geometrie.

MERGE INTO TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT 
        a.OBJECTID,
        a.DOSSIER || '\' || a.OBJECTID || '_' || b.OBJECTID ||'_' || c.CODE_INSEE || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE, '.', -1, 1),LENGTH(a.LIEN_MODIFIE)) AS LIEN_RENOMMAGE_FICHIER
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
        INNER JOIN G_GESTIONGEO.TA_GG_DOSSIER b ON a.ID_DOS = b.OBJECTID
        INNER JOIN G_GESTIONGEO.TA_GG_GEO c ON b.FID_PERIMETRE = c.OBJECTID
    WHERE
        c.CODE_INSEE <> 'error'
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;

-- 8.2. MISE A JOUR DE LA COLONNE LIEN_RENOMMAGE_FICHIER POUR LES DOSSIERS SANS ID_DOS OU GEOMETRIE N'EST DANS AUCUNE COMMUNE, NOUS GARDONS ALORS LE NOM ORIGINAL DU FICHIER
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        LIEN_MODIFIE AS LIEN_RENOMMAGE_FICHIER
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NULL OR LIEN_RENOMMAGE_FICHIER IS NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER = b.LIEN_RENOMMAGE_FICHIER
;
COMMIT;


-- 9. LIEN_RENOMMAGE_FICHIER_BASE
-- 9.1. Creation de la colonne LIEN_RENOMMAGE_FICHIER_BASE
ALTER TABLE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
ADD (LIEN_RENOMMAGE_FICHIER_BASE VARCHAR2(4000));
COMMIT;

-- 9.2.1. DANS LE CAS OU UN ID_DOS EST PRESENT
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT 
        a.OBJECTID,
        a.OBJECTID || '_' || b.OBJECTID ||'_' || c.CODE_INSEE || SUBSTR(LIEN_MODIFIE, INSTR(a.LIEN_MODIFIE, '.', -1, 1),LENGTH(a.LIEN_MODIFIE)) AS LIEN_RENOMMAGE_FICHIER_BASE
    FROM 
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
        INNER JOIN G_GESTIONGEO.TA_GG_DOSSIER b ON a.ID_DOS = b.OBJECTID
        INNER JOIN G_GESTIONGEO.TA_GG_GEO c ON b.FID_PERIMETRE = c.OBJECTID
    WHERE
        c.CODE_INSEE <> 'error'
    AND a.ID_DOS IS NOT NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER_BASE = b.LIEN_RENOMMAGE_FICHIER_BASE
;
COMMIT;


-- 9.2.2. Dans le cas ou le fichier à un ID_DOS mais pas de géométrie:
-- Dans le cas ou il n'y a pas ID_DOS
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        CASE
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\RECOL\%'
            THEN
                SUBSTR(LIEN_MODIFIE,INSTR(LIEN_MODIFIE,'\',-1,1)+1, LENGTH(LIEN_MODIFIE))
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\IC\%'
            THEN
                SUBSTR(LIEN_MODIFIE,INSTR(LIEN_MODIFIE,'\',-1,1)+1, LENGTH(LIEN_MODIFIE))
        END LIEN_RENOMMAGE_FICHIER_BASE
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NOT NULL AND ID_DOS NOT IN (
                                        SELECT
                                            a.objectid
                                        FROM
                                            G_GESTIONGEO.TA_GG_DOSSIER a
                                            INNER JOIN G_GESTIONGEO.TA_GG_GEO b ON b.objectid = a.fid_perimetre 
                                        WHERE
                                            b.CODE_INSEE <> 'error'
                                            )
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER_BASE = b.LIEN_RENOMMAGE_FICHIER_BASE
;
COMMIT;


-- 9.2.3.
-- Dans le cas ou il n'y a pas ID_DOS
MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID,
        CASE
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\RECOL\%'
            THEN
                SUBSTR(LIEN_MODIFIE,INSTR(LIEN_MODIFIE,'\',-1,1)+1, LENGTH(LIEN_MODIFIE))
        WHEN LIEN_MODIFIE LIKE 'C:\Users\rjault\Documents\14_GESTION_GEO\Appli_GG\IC\%'
            THEN
                SUBSTR(LIEN_MODIFIE,INSTR(LIEN_MODIFIE,'\',-1,1)+1, LENGTH(LIEN_MODIFIE))
        END LIEN_RENOMMAGE_FICHIER_BASE
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IS NULL OR LIEN_RENOMMAGE_FICHIER IS NULL
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED THEN
UPDATE SET a.LIEN_RENOMMAGE_FICHIER_BASE = b.LIEN_RENOMMAGE_FICHIER_BASE
;
COMMIT;


-- 10. MISE A JOUR LE COLONNE INTEGRATION.

-- 10.1. MISE A 1 DE LA COLONNE POUR LES DOSSIERS OU UN SEUL FICHIER EST PRESENT.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        ID_DOS IN
        (SELECT ID_DOS FROM (
        (
        SELECT
            COUNT(ID_DOS),
            ID_DOS
        FROM
            (
            SELECT
                ID_DOS
            FROM
                G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
            WHERE
                UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) IN ('DWG','DXF')
            )
        GROUP BY
            ID_DOS
        HAVING COUNT(ID_DOS) = 1
        )))
    AND
        UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) IN ('DWG','DXF')
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED
THEN UPDATE SET INTEGRATION =1
;
COMMIT;

-- 10.2. MISE A 0 DE LA COLONNE INTEGRATION POUR LES DOSSIERS OU LES AUTRES FICHIERS D UN DOSSIER OU UN FICHIER EST DEJA A 1.

MERGE INTO G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
USING
    (
    SELECT
        OBJECTID
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE ID_DOS
        IN 
        (
        SELECT
            ID_DOS
        FROM
            G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
        WHERE
            INTEGRATION =1      
        )
    AND UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) NOT IN ('DWG','DXF')
    )b
ON (a.OBJECTID = b.OBJECTID)
WHEN MATCHED
THEN UPDATE SET INTEGRATION =0
;
COMMIT;

-- 11. MISE A 0 DE LA COLONNE INTEGRATION POUR LES ELEMENTS QUI NE SONT NI DES FICHIERS DWG OU DXF.

UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO a
SET INTEGRATION = 0
WHERE UPPER(SUBSTR(LIEN_MODIFIE,-3,3)) NOT IN ('DWG','DXF');
COMMIT;

-- 12. Suppression de la séquence
DROP SEQUENCE SEQ_TA_GG_FICHIER_OBJECTID;

-- 13. MERGE AVEC LA TABLE G_GESTIONGEO.TA_GG_FICHIER.
-- 13.1. Dans le cas ou il y a un ID_DOS
MERGE INTO G_GESTIONGEO.TA_GG_FICHIER a
USING (
    SELECT
        OBJECTID AS OBJECTID,
        ID_DOS AS FID_DOSSIER,
        LIEN_RENOMMAGE_FICHIER_BASE AS FICHIER,
        INTEGRATION AS INTEGRATION
    FROM
        G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
    WHERE
        LIEN_RENOMMAGE_FICHIER_BASE IS NOT NULL
    AND
        LIEN NOT LIKE '%.db%'
    )b
ON (a.FID_DOSSIER = b.FID_DOSSIER
AND a.FICHIER = b.FICHIER)
WHEN NOT MATCHED THEN
INSERT (a.OBJECTID, a.FID_DOSSIER, a.FICHIER, a.INTEGRATION)
VALUES (b.OBJECTID, b.FID_DOSSIER, b.FICHIER, b.INTEGRATION)
;
COMMIT;

-- 14. Creation de la séquence à la bonne valeur de depart.
SET SERVEROUTPUT ON
DECLARE
    v_new_id NUMBER(38,0);

    BEGIN
    -- Sélection de l''ID_GEOM à partir duquel faire reprendre l'incrémentation
        SELECT
            MAX(OBJECTID) + 1
            INTO v_new_id
        FROM
            G_GESTIONGEO.TA_GG_FICHIER;

    -- Création de la séquence du trigger pour TEMP_TA_GG_FICHIER
        EXECUTE IMMEDIATE 'CREATE SEQUENCE SEQ_TA_GG_FICHIER_OBJECTID INCREMENT BY 1 START WITH ' || v_new_id;
    END;

    /

-- 15. AJOUT DES GUILLEMETS DANS LA COLONNE LIEN
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET LIEN = '"' || LIEN || '"';
COMMIT;

-- 16. AJOUT DES GUILLEMETS DANS LA COLONNE LIEN
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET LIEN_RENOMMAGE_FICHIER = '"' || LIEN_RENOMMAGE_FICHIER || '"';
COMMIT;

-- 17. AJOUT DES GUILLEMETS DANS LA COLONNE LIEN
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET DOSSIER = '"' || DOSSIER || '"';
COMMIT;

-- 18. AJOUT DES GUILLEMETS DANS LA COLONNE LIEN
UPDATE G_GESTIONGEO.TEMP_LISTE_FICHIER_GESTION_GEO
SET LIEN_RENOMMAGE_DOSSIER = '"' || LIEN_RENOMMAGE_DOSSIER || '"';
COMMIT;